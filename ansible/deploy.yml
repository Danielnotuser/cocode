---
- name: Deploy cocode application (simple)
  hosts: all
  become_user: "{{ ansible_user }}"
  become: yes  
  vars:
    app_dir: "/home/{{ ansible_user }}/cocode-app-new"
    
  tasks:
    - name: Install Node.js (если не установлен)
      raw: |
        which node > /dev/null 2>&1 || (curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - && sudo apt-get install -y nodejs)

    - name: Install Go (если не установлен)
      raw: |
        sudo apt-get install golang -y

    - name: Delete directory
      become_user: "{{ ansible_user }}"
      become: yes  
      file:
        path: "{{ app_dir }}"
        state: absent

    - name: Create application directory
      git:
        repo: "https://github.com/Danielnotuser/cocode.git"
        dest: "{{ app_dir }}"
        version: "deploy"
        clone: yes
        update: yes

    - name: Install Node.js dependencies
      command: "npm install"
      args:
        chdir: "{{ app_dir }}"

    - name: Build frontend
      command: "npm run build"
      args:
        chdir: "{{ app_dir }}"

    - name: Install Go dependencies
      command: "go mod tidy"
      args:
        chdir: "{{ app_dir }}"
      environment:
        PATH: "/usr/local/go/bin:{{ ansible_env.PATH }}"

    - name: Build Go application
      command: "go build -o cocode-server ."
      args:
        chdir: "{{ app_dir }}"
      environment:
        PATH: "/usr/local/go/bin:{{ ansible_env.PATH }}"

    - name: Kill existing processes
      shell: | 
        pkill -f {{ item }} || true
      args:
        executable: /bin/bash
      loop:
        - "cocode-server"
        - "y-websocket"
      ignore_errors: yes

    - name: Start Go server
      shell: |
        cd {{ app_dir }}
        nohup ./cocode-server > go-server.log 2>&1 &
        echo $! > go-server.pid
      args:
        executable: /bin/bash

    - name: Start WebSocket server
      shell: |
        cd {{ app_dir }}
        nohup npx y-websocket > websocket.log 2>&1 &
        echo $! > websocket.pid
      args:
        executable: /bin/bash
      environment:
        PORT: "81"

    - name: Wait for servers to start
      wait_for:
        port: "{{ item }}"
        host: localhost
        delay: 3
        timeout: 15
      loop:
        - 80
        - 81

    - name: Check running processes
      shell: |
        echo "=== Go server process ==="
        ps -p $(cat {{ app_dir }}/go-server.pid 2>/dev/null || echo 0) || echo "Not running"
        echo "=== WebSocket process ==="
        ps -p $(cat {{ app_dir }}/websocket.pid 2>/dev/null || echo 0) || echo "Not running"
      register: process_check

    - name: Show process status
      debug:
        var: process_check.stdout
