{{template "base.html" .}}

{{define "editor-content"}}
<div class="editor-container">
    <div class="editor-header">
        <h2>Editor: {{.Session.ProjectName}}</h2>
        <div class="session-info">
            <span>Language: {{.Session.Language}}</span>
            <span>Session ID: {{.SessionID}}</span>
            <span>Owner: {{.Session.Owner}}</span>
            {{if ne .Session.Owner .Username}}
            <span style="color: #666;">(You are a collaborator)</span>
            {{end}}
            <span id="connection-status" style="margin-left: 20px; color: #FF9800;">⟳ Connecting...</span>
        </div>
    </div>

    {{if eq .Session.Owner .Username}}
    <div class="collab-submenu">
        <form action="/add-collab" method="POST" class="ajax-form" data-redirect="/editor?session_id={{.SessionID}}">
            <input type="hidden" name="session_id" value="{{.SessionID}}">
            <input type="text" name="username" placeholder="Add collaborator by username" required class="collab-input">
            <button type="submit" class="collab-btn">Add</button>
        </form>
    </div>
    {{end}}

    <div class="editor-area">
        <textarea id="code-editor">{{.Session.Content}}</textarea>
    </div>
</div>

<!-- Load frontend bundle (contains CodeMirror + Yjs) -->
<script src="/static/app.js"></script>

<script>
    // Wait for bundle to load, then initialize
    function initEditor() {
        try {
            console.log('[Yjs] Initializing editor with CRDT support');
            
            // Check if functions are available
            if (typeof window.initializeYjsEditor !== 'function') {
                throw new Error('initializeYjsEditor not found in window');
            }
            
            const { ydoc, provider, binding, editor } = window.initializeYjsEditor(
                "{{.SessionID}}", 
                "{{.Username}}", 
                "{{.Session.Language}}", 
                `{{.Session.Content}}`
            );
            
            // Cleanup on unload
            window.addEventListener('beforeunload', () => {
                window.cleanupYjs(provider);
            });
            
            console.log('[Yjs] Editor initialized with collaborative editing');
        } catch (error) {
            console.error('[Yjs] Error initializing editor:', error);
            console.error('Stack:', error.stack);
            
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                statusEl.textContent = '✗ Error: ' + error.message;
                statusEl.style.color = '#f44336';
            }
        }
    }
    
    // Initialize when document is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEditor);
    } else {
        initEditor();
    }
</script>

{{end}}