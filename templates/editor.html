{{template "base.html" .}}

{{define "editor-content"}}
<div class="editor-container">
    <div class="editor-header">
        <h2>Editor: {{.Session.ProjectName}}</h2>
        <div class="session-info">
            <span>Language: {{.Session.Language}}</span>
            <span>Session ID: {{.SessionID}}</span>
            <span>Owner: {{.Session.Owner}}</span>
            {{if ne .Session.Owner .Username}}
            <span style="color: #666;">(You are a collaborator)</span>
            {{end}}
        </div>
    </div>

    {{if eq .Session.Owner .Username}}
    <div class="collab-submenu">
        <form action="/add-collab" method="POST" class="ajax-form" data-redirect="/editor?session_id={{.SessionID}}">
            <input type="hidden" name="session_id" value="{{.SessionID}}">
            <input type="text" name="username" placeholder="Add collaborator by username" required class="collab-input">
            <button type="submit" class="collab-btn">Add</button>
        </form>
    </div>
    {{end}}

    <div class="editor-area">
        <div id="editor"></div>
    </div>
</div>

<!-- Подключаем Yjs через CDN -->
<script src="https://cdn.jsdelivr.net/npm/yjs@1.4.0/dist/yjs.js"></script>
<script src="https://cdn.jsdelivr.net/npm/y-websocket@1.4.5/bin/y-websocket.js"></script>

<script type="module">
    // Импортируем CodeMirror 6 через CDN
    import { EditorView, basicSetup } from 'https://esm.sh/@codemirror/view@6.0.0';
    import { EditorState } from 'https://esm.sh/@codemirror/state@6.0.0';
    import { javascript } from 'https://esm.sh/@codemirror/lang-javascript@6.0.0';
    import { python } from 'https://esm.sh/@codemirror/lang-python@6.0.0';
    import { go } from 'https://esm.sh/@codemirror/lang-go@6.0.0';
    import { java } from 'https://esm.sh/@codemirror/lang-java@6.0.0';
    import { html } from 'https://esm.sh/@codemirror/lang-html@6.0.0';
    import { css } from 'https://esm.sh/@codemirror/lang-css@6.0.0';
    import { yCollab } from 'https://esm.sh/y-codemirror.next@1.0.2';

    // Конфигурация
    const sessionId = '{{.SessionID}}';
    const username = '{{.Username}}';
    const initialContent = `{{.Session.Content}}`;

    // Инициализация Yjs
    const ydoc = new Y.Doc();

    // Подключаемся к WebSocket серверу Yjs
    const provider = new Y.WebsocketProvider(
        'ws://localhost:1234',
        'cocode-session-' + sessionId,
        ydoc
    );

    const ytext = ydoc.getText('codemirror');
    const undoManager = new Y.UndoManager(ytext);

    // Генерируем цвет для пользователя
    function generateUserColor(username) {
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
        ];
        let hash = 0;
        for (let i = 0; i < username.length; i++) {
            hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
    }

    // Настройка awareness (курсоры других пользователей)
    provider.awareness.setLocalStateField('user', {
        name: username,
        color: generateUserColor(username)
    });

    // Выбираем язык программирования
    function getLanguageExtension() {
        const lang = '{{.Session.Language}}'.toLowerCase();
        switch(lang) {
            case 'javascript': return javascript();
            case 'python': return python();
            case 'go': return go();
            case 'java': return java();
            case 'html': return html();
            case 'css': return css();
            default: return javascript();
        }
    }

    // Инициализация начального контента
    if (initialContent && initialContent !== '') {
        ytext.insert(0, initialContent);
    }

    // Инициализация редактора
    const editor = new EditorView({
        state: EditorState.create({
            doc: ytext.toString(),
            extensions: [
                basicSetup,
                getLanguageExtension(),
                yCollab(ytext, provider.awareness, { undoManager })
            ]
        }),
        parent: document.getElementById('editor')
    });

    // Автосохранение в базу данных при изменениях
    let saveTimeout;
    ytext.observe(() => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            const content = ytext.toString();

            fetch('/save-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'session_id=' + encodeURIComponent(sessionId) + '&content=' + encodeURIComponent(content)
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Save error:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Save request failed:', error);
                });
        }, 1000); // Сохраняем через 1 секунду после изменения
    });

    // Обработка отключения WebSocket
    provider.on('status', event => {
        if (event.status === 'disconnected') {
            console.log('Disconnected from collaboration server');
        } else if (event.status === 'connected') {
            console.log('Connected to collaboration server');
        }
    });

    // Обновление размеров редактора
    function updateEditorSize() {
        const container = document.querySelector('.editor-area');
        if (container && editor) {
            editor.dispatch({
                effects: EditorView.domEventHandlers({
                    resize: () => {
                        // CodeMirror 6 автоматически обрабатывает ресайз
                    }
                })
            });
        }
    }

    window.addEventListener('resize', updateEditorSize);
    setTimeout(updateEditorSize, 100);
</script>
{{end}}