{{template "base.html" .}}

{{define "editor-content"}}
<div class="editor-container">
    <div class="editor-header">
        <h2>Editor: {{.Session.ProjectName}}</h2>
        <div class="session-info">
            <span>Language: {{.Session.Language}}</span>
            <span>Session ID: {{.SessionID}}</span>
            <span>Owner: {{.Session.Owner}}</span>
            {{if ne .Session.Owner .Username}}
            <span style="color: #666;">(You are a collaborator)</span>
            {{end}}
            <span id="connection-status" style="margin-left: 20px; color: #FF9800;">⟳ Connecting...</span>
        </div>
    </div>

    {{if eq .Session.Owner .Username}}
    <div class="collab-submenu">
        <form action="/add-collab" method="POST" class="ajax-form" data-redirect="/editor?session_id={{.SessionID}}">
            <input type="hidden" name="session_id" value="{{.SessionID}}">
            <input type="text" name="username" placeholder="Add collaborator by username" required class="collab-input">
            <button type="submit" class="collab-btn">Add</button>
        </form>
    </div>
    {{end}}

    <div class="editor-area">
        <label><textarea id="code-editor"></textarea></label>
    </div>
    <div class="editor-actions" style="margin-top:10px;">
        <!-- Interpret button shown only for python sessions -->
        {{if eq .Session.Language "Python"}}
        <button id="interpret-btn" class="collab-btn">Interpret</button>
        <span id="interpret-status" style="margin-left:12px; color:#666"></span>
        {{end}}
    </div>

    {{if eq .Session.Language "Python"}}
    <div class="editor-inputs" style="margin-top:12px;">
        <label style="display:block; margin-bottom:6px; color:#666">Program Input (stdin):</label>
        <textarea id="program-stdin" placeholder="Enter input for the program (stdin)" style="width:100%; min-height:80px; font-family:monospace;"></textarea>
    </div>
    {{end}}

    <div id="interpret-output" style="white-space:pre-wrap; background:#1e1e1e; color:#ddd; padding:10px; margin-top:12px; border-radius:4px; display:none; max-height:400px; overflow:auto;"></div>
</div>

<!-- Load frontend bundle (contains CodeMirror + Yjs) -->
<script src="/static/app.js"></script>

<script>
    // Wait for bundle to load, then initialize
    function initEditor() {
        try {
            console.log('[Yjs] Initializing editor with CRDT support');

            // Check if functions are available
            if (typeof window.initializeYjsEditor !== 'function') {
                throw new Error('initializeYjsEditor not found in window');
            }

            const { ydoc, provider, binding, editor } = window.initializeYjsEditor(
                "{{.SessionID}}",
                "{{.Username}}",
                "{{.Session.Language}}",
                `{{.Session.Content}}`
            );

            // Expose the editor to global scope for buttons to read content
            window.activeEditor = editor;

            // Cleanup on unload
            window.addEventListener('beforeunload', () => {
                window.cleanupYjs(provider);
            });

            // Setup interpret button if available
            const interpretBtn = document.getElementById('interpret-btn');
            if (interpretBtn) {
                interpretBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const statusEl = document.getElementById('interpret-status');
                    const outputEl = document.getElementById('interpret-output');
                    if (statusEl) {
                        statusEl.textContent = 'Running...';
                        statusEl.style.color = '#FF9800';
                    }
                    if (outputEl) {
                        outputEl.style.display = 'none';
                        outputEl.textContent = '';
                    }

                    // Get code from active editor or fallback textarea
                    let code = '';
                    try {
                        if (window.activeEditor && typeof window.activeEditor.getValue === 'function') {
                            code = window.activeEditor.getValue();
                        } else {
                            const ta = document.getElementById('code-editor');
                            code = ta ? ta.value : '';
                        }
                    } catch (err) {
                        code = '';
                    }

                    // send to server (include stdin if present)
                    try {
                        const stdinArea = document.getElementById('program-stdin');
                        const stdinVal = stdinArea ? stdinArea.value : '';
                        const resp = await fetch('/interpret', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ session_id: "{{.SessionID}}", content: code, stdin: stdinVal })
                        });
                        const data = await resp.json();
                        const hasError = !resp.ok || data.error;
                        if (hasError) {
                            if (statusEl) {
                                statusEl.textContent = 'Error';
                                statusEl.style.color = '#f44336';
                            }
                            // Show both error message and any captured output (stdout/stderr)
                            let combined = '';
                            if (data.error) {
                                combined += 'Error: ' + data.error;
                            }
                            if (data.output) {
                                if (combined) combined += '\n\n';
                                combined += data.output;
                            }
                            if (!combined) combined = 'Unknown error';
                            if (outputEl) {
                                outputEl.style.display = 'block';
                                outputEl.textContent = combined;
                                outputEl.style.color = '#f44336';
                            }
                        } else {
                            if (statusEl) {
                                statusEl.textContent = 'Finished';
                                statusEl.style.color = '#4CAF50';
                            }
                            if (outputEl) {
                                outputEl.style.display = 'block';
                                outputEl.textContent = data.output || '';
                                outputEl.style.color = '#ddd';
                            }
                        }
                    } catch (err) {
                        if (statusEl) {
                            statusEl.textContent = 'Error';
                            statusEl.style.color = '#f44336';
                        }
                        const outputEl2 = document.getElementById('interpret-output');
                        if (outputEl2) {
                            outputEl2.style.display = 'block';
                            outputEl2.textContent = String(err);
                        }
                    }
                });
            }

            console.log('[Yjs] Editor initialized with collaborative editing');
        } catch (error) {
            console.error('[Yjs] Error initializing editor:', error);
            console.error('Stack:', error.stack);

            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                statusEl.textContent = '✗ Error: ' + error.message;
                statusEl.style.color = '#f44336';
            }
        }
    }

    // Initialize when document is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEditor);
    } else {
        initEditor();
    }
</script>

{{end}}